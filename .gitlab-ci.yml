# Continuous Integration testing for KHARMA
# a.k.a did we break the basics?

# Build on Nvidia image.
# Can pretty easily change this out
# Someday we'll build & push a KHARMA image, then test that
image: nvcr.io/nvidia/nvhpc:22.9-devel-cuda_multi-rockylinux8

variables:
  NPROC: 24
  OMP_NUM_THREADS: 24
  MPI_EXE: mpirun
  GIT_SUBMODULE_STRATEGY: recursive

# Install pyharm for verification
before_script:
  - wget -O Miniforge3.sh "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh"
  - bash Miniforge3.sh -b -p "${HOME}/conda"
  - source "${HOME}/conda/etc/profile.d/conda.sh"
  - git clone https://github.com/AFD-Illinois/pyharm.git
  - conda activate
  - cd pyharm
  - pip install -e .
  - cd ..

# Tests can be executed in parallel
stages:
  - build
  - tests

build:
  stage: build
  script:
    - export PREFIX_PATH=$PWD/external/hdf5
    - ./make.sh clean cuda hdf5
  artifacts:
    paths:
      - kharma.*
      - make_args

convergence:
  stage: tests
  script:
    - cd tests/bondi/
    - bash run.sh
    - bash check.sh
    - cd ../mhdmodes
    - bash run.sh
    - bash check.sh
    - cd ../emhdmodes
    - bash run.sh
    - bash check.sh
  artifacts:
    when: always
    paths:
      - tests/*/*.png
      - tests/*/*.hst
      - tests/*/*.txt

noh:
  stage: tests
  before_script:
    - cd tests/noh/
  script:
    - bash run.sh
    - bash check.sh
  artifacts:
    when: always
    paths:
      - tests/noh/*.png
      - tests/noh/*.hst

bz_monopole:
  stage: tests
  before_script:
    - cd tests/bz_monopole
  script:
    # Always run check.sh, but fail
    # if run.sh returned error
    - exit_code=0
    - bash run.sh || exit_code=$?
    - bash check.sh
    - exit $exit_code
  artifacts:
    when: always
    paths:
      - tests/bz_monopole/*.png
      - tests/bz_monopole/*.hst

tilt_init:
  stage: tests
  before_script:
    - cd tests/tilt_init
  script:
    - exit_code=0
    - bash run.sh || exit_code=$?
    - bash check.sh
    - exit $exit_code
  artifacts:
    when: always
    paths:
      - tests/tilt_init/*.png
      - tests/tilt_init/*.hst

restart:
  stage: tests
  before_script:
    - cd tests/restart
  script:
    - bash run.sh
    - bash check.sh
  artifacts:
    when: always
    paths:
      - tests/restart/*.png

reinit:
  stage: tests
  before_script:
    - cd tests/reinit
  script:
    - bash run.sh
    - bash check.sh
